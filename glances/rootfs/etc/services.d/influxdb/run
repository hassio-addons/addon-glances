#!/usr/bin/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: Glances
# Runs Glances InfluxDB Export
# ==============================================================================
declare -a options

if bashio::config.false 'influxdb.enabled' && bashio::config.false 'influxdb2.enabled'; then
    # This script is re-run by systemd whenever it terminates, so sleep for a
    # while to avoid a continual loop.
    exec sleep 86400
fi

function glances_export() {
    influxdb_version="$1"
    sleep_interval="$2"

    options+=(-C /etc/glances.conf)
    options+=(--export "$influxdb_version")
    options+=(--quiet)

    options+=(--time "$(bashio::config 'refresh_time')")

    if bashio::config.false 'process_info'; then
        options+=(--disable-process)
    fi

    if bashio::debug; then
        options+=(--debug)
    fi

    sleep "$sleep_interval"
    glances "${options[@]}"
}

# Run the export processes in the background, then wait for both to complete
# (otherwise we delay one export by the other's interval).
if bashio::config.true 'influxdb.enabled'; then
    glances_export "influxdb" "$(bashio::config 'influxdb.interval')" &
fi
if bashio::config.true 'influxdb2.enabled'; then
    glances_export "influxdb2" "$(bashio::config 'influxdb2.interval')" &
fi
wait